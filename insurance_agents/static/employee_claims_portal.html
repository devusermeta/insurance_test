<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insurance Claims Processing - Employee Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 0;
            min-height: 600px;
        }

        .chat-section {
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 400px;
            border: 2px solid #e9ecef;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: white;
            border: 2px solid #e3f2fd;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            background: #fff3e0;
            border: 2px solid #ffcc02;
            color: #f57c00;
            text-align: center;
            margin: 0 auto;
            font-style: italic;
        }

        .message.error {
            background: #ffebee;
            border: 2px solid #f44336;
            color: #c62828;
            border-bottom-left-radius: 4px;
        }

        .message.success {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            color: #2e7d32;
            border-bottom-left-radius: 4px;
        }

        .input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        .input-container input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .input-container input:focus {
            border-color: #2a5298;
        }

        .send-button {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .send-button:hover {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            transform: translateY(-2px);
        }

        .sidebar {
            background: #f8f9fa;
            border-left: 2px solid #e9ecef;
            padding: 30px 20px;
        }

        .status-panel {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }

        .status-panel h3 {
            color: #2a5298;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .status-indicator {
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-indicator.ready {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .status-indicator.processing {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-indicator.waiting {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-indicator.error {
            background: #ffebee;
            color: #c62828;
        }

        .quick-actions {
            background: white;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }

        .quick-actions h3 {
            color: #2a5298;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .quick-button {
            display: block;
            width: 100%;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 0.9rem;
            color: #333;
        }

        .quick-button:hover {
            background: #2a5298;
            color: white;
            border-color: #2a5298;
        }

        .examples {
            margin-top: 20px;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .examples h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .examples ul {
            list-style: none;
        }

        .examples li {
            margin-bottom: 8px;
            padding-left: 15px;
            position: relative;
        }

        .examples li:before {
            content: "üí°";
            position: absolute;
            left: 0;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-left: none;
                border-top: 2px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Insurance Claims Portal</h1>
            <p>Complete claims processing with intelligent workflow automation</p>
        </div>

        <div class="main-content">
            <div class="chat-section">
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        üëã <strong>Welcome to the Insurance Claims Portal!</strong><br><br>
                        I'm your AI assistant for processing insurance claims. I can help you:<br>
                        ‚Ä¢ Process claims through our automated workflow<br>
                        ‚Ä¢ Search our database for patient and claim information<br>
                        ‚Ä¢ Check claim status and history<br><br>
                        <strong>Try:</strong> "Process claim with OP-05"
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Type your message here (e.g., 'Process claim with OP-05')..."
                            autocomplete="off"
                        >
                    </div>
                    <button class="send-button" onclick="sendMessage()">
                        Send üì§
                    </button>
                </div>
            </div>

            <div class="sidebar">
                <div class="status-panel">
                    <h3>üîÑ System Status</h3>
                    <div class="status-indicator ready" id="statusIndicator">
                        ‚úÖ Ready for Processing
                    </div>
                    <div id="statusDetails" style="font-size: 0.9rem; color: #666;">
                        All systems operational
                    </div>
                </div>

                <div class="quick-actions">
                    <h3>‚ö° Quick Actions</h3>
                    <button class="quick-button" onclick="quickMessage('Process claim with OP-05')">
                        üè• Process Outpatient Claim OP-05
                    </button>
                    <button class="quick-button" onclick="quickMessage('Process claim with IP-01')">
                        üè® Process Inpatient Claim IP-01
                    </button>
                    <button class="quick-button" onclick="quickMessage('Show me patient John Doe')">
                        üë§ Search Patient Database
                    </button>
                    <button class="quick-button" onclick="quickMessage('Find claims over $500')">
                        üîç Search Claims by Amount
                    </button>
                </div>

                <div class="examples">
                    <h4>üí° Example Commands</h4>
                    <ul>
                        <li>"Process claim with [CLAIM-ID]"</li>
                        <li>"Show me patient [NAME]"</li>
                        <li>"Find claims over $[AMOUNT]"</li>
                        <li>"What is the status of claim [ID]"</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = generateSessionId();
        let isWaitingForConfirmation = false;

        function generateSessionId() {
            return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }

        function addMessage(type, content, timestamp = null) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            // Format message content
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/üéØ|üîÑ|‚úÖ|‚ùå|üìä|üí∞|üè•|ü©∫|üë§|üÜî|üìã|‚ö†Ô∏è|üéâ|üö´|üí¨|‚è∞|üìû|üîç/g, '<span style="font-size: 1.1em;">$&</span>');
            
            if (timestamp) {
                formattedContent += `<br><small style="opacity: 0.7; font-size: 0.8em;">${timestamp}</small>`;
            }
            
            messageDiv.innerHTML = formattedContent;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateStatus(status, requiresConfirmation = false, details = null) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusDetails = document.getElementById('statusDetails');
            
            isWaitingForConfirmation = requiresConfirmation;

            switch(status) {
                case 'pending_confirmation':
                    statusIndicator.className = 'status-indicator waiting';
                    statusIndicator.innerHTML = '‚è≥ Waiting for Confirmation';
                    statusDetails.innerHTML = 'Please confirm the claim processing request';
                    break;
                case 'processing':
                    statusIndicator.className = 'status-indicator processing';
                    statusIndicator.innerHTML = 'üîÑ Processing Claim';
                    statusDetails.innerHTML = 'Running automated workflow...';
                    break;
                case 'completed':
                    statusIndicator.className = 'status-indicator ready';
                    statusIndicator.innerHTML = '‚úÖ Processing Complete';
                    statusDetails.innerHTML = 'Ready for next request';
                    break;
                case 'error':
                    statusIndicator.className = 'status-indicator error';
                    statusIndicator.innerHTML = '‚ùå Error Occurred';
                    statusDetails.innerHTML = details || 'Please try again';
                    break;
                case 'cancelled':
                    statusIndicator.className = 'status-indicator ready';
                    statusIndicator.innerHTML = 'üö´ Processing Cancelled';
                    statusDetails.innerHTML = 'Ready for next request';
                    break;
                default:
                    statusIndicator.className = 'status-indicator ready';
                    statusIndicator.innerHTML = '‚úÖ Ready for Processing';
                    statusDetails.innerHTML = 'All systems operational';
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessage('user', message, new Date().toLocaleTimeString());
            input.value = '';

            // Update status to processing
            updateStatus('processing');

            try {
                // Simulate API call (replace with actual backend)
                const response = await simulateBackendCall(message);
                
                // Add assistant response
                addMessage('assistant', response.message, new Date().toLocaleTimeString());
                updateStatus(response.status, response.requires_confirmation, response.details);
                
            } catch (error) {
                console.error('Error sending message:', error);
                addMessage('error', '‚ùå Failed to send message. Please try again.');
                updateStatus('error', false, 'Connection failed');
            }
        }

        async function simulateBackendCall(message) {
            // Extended processing delay to allow for real agent workflow (5 minutes total)
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Parse claim ID
            const claimMatch = message.match(/claim\s+with\s+([A-Z]+-\d+)/i);
            
            if (claimMatch) {
                const claimId = claimMatch[1];
                
                if (isWaitingForConfirmation && message.toLowerCase().includes('yes')) {
                    // Show progress indicator for extended workflow
                    addMessage('assistant', 'üîÑ **Processing claim through multi-agent workflow...**\n\n‚è≥ This may take up to 5 minutes as agents analyze documents and validate coverage.\n\nüìä **Progress:**\nüîÑ Starting workflow...');
                    
                    // Extended A2A workflow execution time (5 minutes)
                    await new Promise(resolve => setTimeout(resolve, 300000)); // 5 minutes
                    
                    return {
                        status: 'completed',
                        message: `üéâ **Claim Processing Complete!**

üÜî **Claim ID:** ${claimId}
üìä **Final Decision:** **APPROVED**
üí¨ **Reason:** Claim validated and approved by all agents

**Processing Steps:**
‚úÖ coverage_rules_engine: SUCCESS
‚úÖ document_intelligence: SUCCESS  
‚úÖ intake_clarifier: SUCCESS

‚è∞ **Completed:** ${new Date().toLocaleString()}
‚åõ **Processing Time:** 5 minutes`,
                        requires_confirmation: false,
                        details: 'Workflow completed successfully after full agent processing'
                    };
                }
                
                // Simulate claim details extraction
                const patientNames = ['John Doe', 'Jane Smith', 'Michael Johnson', 'Sarah Wilson'];
                const categories = ['Outpatient', 'Inpatient'];
                const diagnoses = ['General Checkup', 'Emergency Care', 'Routine Surgery', 'Dental Care'];
                
                const randomPatient = patientNames[Math.floor(Math.random() * patientNames.length)];
                const randomCategory = categories[Math.floor(Math.random() * categories.length)];
                const randomDiagnosis = diagnoses[Math.floor(Math.random() * diagnoses.length)];
                const randomAmount = (Math.random() * 2000 + 100).toFixed(2);
                
                return {
                    status: 'pending_confirmation',
                    message: `üìã **Claim Details Found:**

üÜî **Claim ID:** ${claimId}
üë§ **Patient:** ${randomPatient}
üí∞ **Amount:** $${randomAmount}
üè• **Category:** ${randomCategory}
ü©∫ **Diagnosis:** ${randomDiagnosis}
üìä **Status:** Submitted

**Please confirm:** Do you want to proceed with processing this claim? (Type 'yes' to confirm)`,
                    requires_confirmation: true,
                    details: 'Waiting for employee confirmation'
                };
            }
            
            // Handle other queries
            if (message.toLowerCase().includes('patient') || message.toLowerCase().includes('search')) {
                return {
                    status: 'completed',
                    message: `üìä **Database Query Result:**

Found 3 matching records:
‚Ä¢ Patient: John Doe - Claims: 2 active
‚Ä¢ Patient: Jane Doe - Claims: 1 pending
‚Ä¢ Patient: John Smith - Claims: 3 completed

üí° **Tip:** Use "Process claim with [ID]" to start workflow processing.`,
                    requires_confirmation: false,
                    details: 'Database search completed'
                };
            }
            
            // Default help response
            return {
                status: 'completed',
                message: `üëã **Hello! I'm your Insurance Claims Assistant.**

**I can help you with:**
üîπ Process claims: Type 'Process claim with [CLAIM-ID]'
üîπ Search database: Ask about patients, claims, or documents
üîπ View claim status: Ask about specific claim IDs

**Example commands:**
‚Ä¢ 'Process claim with OP-05'
‚Ä¢ 'Show me patient John Doe'
‚Ä¢ 'Find claims over $500'

**Your message:** ${message}`,
                requires_confirmation: false,
                details: 'Help information provided'
            };
        }

        function quickMessage(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        // Enhanced progress tracking for long-running workflows
        function showProgressUpdates(claimId) {
            const progressMessages = [
                'üîÑ Initializing claim processing workflow...',
                'üìã Coverage Rules Engine: Validating policy coverage...',
                'üìÑ Document Intelligence: Analyzing uploaded documents...',
                'ü©∫ Document Intelligence: Extracting medical information...',
                'üîç Intake Clarifier: Reviewing claim details...',
                '‚úÖ Intake Clarifier: Performing final validation...',
                'üìä Orchestrator: Compiling final decision...'
            ];
            
            let currentStep = 0;
            const progressInterval = setInterval(() => {
                if (currentStep < progressMessages.length) {
                    addMessage('assistant', progressMessages[currentStep]);
                    currentStep++;
                } else {
                    clearInterval(progressInterval);
                }
            }, 40000); // Show progress every 40 seconds
            
            return progressInterval;
        }

        // Enhanced error handling with retry logic
        function handleProcessingError(error, claimId) {
            addMessage('error', `‚ö†Ô∏è **Processing Delay Notice**
            
üîÑ Your claim ${claimId} is still being processed by our intelligent agents.
‚è≥ **Expected completion:** Within 5 minutes
üìû **Status:** All agents are working normally

**What's happening:**
‚Ä¢ Coverage Rules Engine: Analyzing policy terms
‚Ä¢ Document Intelligence: Processing medical documents  
‚Ä¢ Intake Clarifier: Validating claim information

üí° **Tip:** Please wait for the full 5-minute processing window before reporting issues.`);
        }

        // Handle Enter key in input
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize status
        updateStatus('ready');
    </script>
</body>
</html>
